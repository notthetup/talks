!function(){"use strict";function find(){if(arguments&&arguments.length)if(recordingMacro())findInMacro(arguments[0]);else{var selector=arguments[0];_currentSelector=selector,_selectedNodes=getNodesWithSelector(selector)}else reset();return _previousNode=null,cracked}function findInMacro(){if(arguments&&arguments.length){for(var selector,selectorArr=arguments[0].split(","),prefix=getCurrentMacroNamespace(),macroUUID=getCurrentMacro().getUUID(),i=0;i<selectorArr.length;i++)selectorArr[i]=-1!==selectorArr[i].indexOf(prefix)?selectorArr[i]:prefix+selectorArr[i];selector=selectorArr.join(","),_currentSelector=selector,_selectedNodes=getNodesWithSelector(selector),_selectedNodes.forEach(function(el,i,arr){el&&getNodeWithUUID(el).getMacroContainerUUID()!==macroUUID&&arr.splice(i,1)})}}function connectPreviousToSelected(){var pNode=getPreviousNode();_selectedNodes.forEach(function(node){node=getNodeWithUUID(node),node&&pNode&&(pNode.connect(node),pNode.pushNextNode(node),node.setPrevNode(pNode),logConnections(pNode,node))})}function reset(){_previousNode=null,_selectedNodes=[],_currentSelector=""}function resetSelection(){_selectedNodes=[],_currentSelector=""}function applyParam(node,keyStr,value,map){for(var mappingResult=resolveParamMapping(keyStr,map),keyArr=mappingResult.path.split("."),keyFunc=mappingResult.fn||function(val){return val},i=0;i<keyArr.length;i++)i+1<keyArr.length&&__.isNotUndef(node[keyArr[i]])?"AudioParam"===node[keyArr[i]].constructor.name?setAudioParam(node[keyArr[i]],value):node=node[keyArr[i]]:node&&__.isNotUndef(node[keyArr[i]])&&(node[keyArr[i]]=keyFunc(value))}function setAudioParam(node,value){if(node&&__.isFun(node.setValueAtTime)){var time=_ignoreGrid?_context.currentTime:_loopTimeToNextStep;node.cancelScheduledValues(time),node.setValueAtTime(value,time)}}function resolveParamMapping(name,map){var mapping=map||{},result=mapping[name]||name;return result.path?result:{path:result}}function createMacro(name,userParams){return createNode(name,{settings:{}},userParams)}function updateMacro(node){recordingMacro()&&(node.setMacroContainerUUID(getCurrentMacro().getUUID()),getCurrentMacro().addNativeNode(node.getNativeNode()))}function recordingMacro(){return!!_currentMacro.length}function getCurrentMacro(){return recordingMacro()?_currentMacro[_currentMacro.length-1]:null}function getCurrentMacroNamespace(){var arr=[],space=" ";if(recordingMacro())for(var i=0;i<_currentMacro.length;i++)arr.push(_currentMacro[i].getType()),arr.push(space);return arr.join("")}function createNode(type,creationParams,userSettings){var node=new AudioNode(type,creationParams,userSettings||{});if(saveNode(node),node.isMacro())return node;for(var nodesToConnect=_selectedNodes.length?_selectedNodes:[getPreviousNode()],i=0;i<nodesToConnect.length;i++){var nodeToConnect=getNodeWithUUID(nodesToConnect[i]);if(nodeToConnect)try{nodeToConnect.connect(node),nodeToConnect.pushNextNode(node),node.setPrevNode(nodeToConnect),logConnections(nodeToConnect,node)}catch(e){throw console.error("ERROR : couldn't connect nodes "+nodeToConnect.getType()+" and "+node.getType()),e}}return resetSelection(),setPreviousNode(node),node}function audioNodeFactory(creationParams){var node;if(_context&&creationParams.method&&_context[creationParams.method]){node=_context[creationParams.method].apply(_context,creationParams.methodParams||[]);for(var creationParam in creationParams.settings)creationParams.settings.hasOwnProperty(creationParam)&&applyParam(node,creationParam,creationParams.settings[creationParam],creationParams.mapping)}else node=_context&&creationParams.method&&!_context[creationParams.method]?_context.destination:[];return logToConsole(node),node}function AudioNode(type,creationParams,userSettings){function updateNativeNode(newNode,id){newNode.uuid=id,updateNativeNodeHelper(nativeNode,newNode)}function updateNativeNodeHelper(currNode,newNode){currNode.forEach(function(n,i,a){__.isArr(n)?updateNativeNodeHelper(n,newNode):n.uuid===newNode.uuid&&(a[i]=newNode)})}function getNodesToConnect(fromNode,toNode){return fromNode&&fromNode.isModulator()&&toNode&&!fromNode.areSiblings(toNode)?{from:getNodeToConnect(fromNode,"from"),to:getNodeToConnectToModulator(toNode,fromNode.isModulatorType())}:{from:getNodeToConnect(fromNode,"from"),to:getNodeToConnect(toNode,"to")}}function getNodeToConnect(node,whichNode){if(node){var rawNode=node.getNativeNode();return __.isArr(rawNode)&&(rawNode="from"===whichNode?rawNode[rawNode.length-1]:rawNode[0]),rawNode}return null}function getNodeToConnectToModulator(node,property){if(node){var rawNode=node.getNativeNode(),resolvedProperty=property;if(__.isArr(rawNode)){for(var i=0;i<rawNode.length;i++)if(resolvedProperty=resolveParamMapping(property,getNodeWithUUID(rawNode[i].uuid).getParamMapping()).path.replace(".value",""),__.isNotUndef(rawNode[i][resolvedProperty])){rawNode=rawNode[i][resolvedProperty];break}}else resolvedProperty=resolveParamMapping(property,node.getParamMapping()).path.replace(".value",""),rawNode=rawNode[resolvedProperty]?rawNode[resolvedProperty]:null;return rawNode}return null}var uuid,macroContainerUUID,parameters,nodeType,nativeNode,prevNode,macroNameSpace="",isPlaying=!1,nextNode=[],paramMapping={},that=this;uuid=generateUUID(),mergeObjects(userSettings,creationParams.settings),mergeObjects(userSettings.mapping,creationParams.mapping),parameters=creationParams,paramMapping=creationParams.mapping||creationParams.settings.mapping,nodeType=type,nativeNode=audioNodeFactory(parameters),nativeNode.uuid=uuid,this.start=function(nodeParam){var currNode=nodeParam||nativeNode;if(__.isArr(currNode))currNode.forEach(function(_node){that.start(_node)});else if(currNode&&__.isFun(currNode.start)){var wrapper=getNodeWithUUID(currNode.uuid);wrapper.getIsPlaying()||(currNode.start(0),wrapper.setIsPlaying(!0),this.setIsPlaying(!0))}},this.stop=function(nodeParam){var currNode=nodeParam||nativeNode;if(__.isArr(currNode))currNode.forEach(function(_node){that.stop(_node)});else if(currNode&&__.isFun(currNode.stop)){var wrapper=getNodeWithUUID(currNode.uuid);wrapper.getIsPlaying()&&(currNode.stop(0),this.resetNode(currNode),wrapper.setIsPlaying(!1),this.setIsPlaying(!1))}},this.ramp=function(target,time,paramToRamp,nodeParam,initial){var currNode=nodeParam||nativeNode;if(__.isArr(currNode))currNode.forEach(function(_node){that.ramp(target,time,paramToRamp,_node,initial)});else{var now=_isLoopRunning?_loopTimeToNextStep:_context.currentTime;if(currNode&&currNode[paramToRamp]&&__.isFun(currNode[paramToRamp].linearRampToValueAtTime)){currNode[paramToRamp].cancelScheduledValues(now);var initialValue=__.ifUndef(initial,currNode[paramToRamp].value),prevTime=0;if(currNode[paramToRamp].setValueAtTime(initialValue,now),__.isArr(target)&&__.isArr(time)&&target.length===time.length)for(var i=0;i<target.length;i++)prevTime=__.isUndef(time[i-1])?0:time[i-1]+prevTime,logToConsole(" target "+target[i]+" time "+(_context.currentTime+prevTime+time[i])),currNode[paramToRamp].linearRampToValueAtTime(target[i],now+prevTime+time[i]);else currNode[paramToRamp].linearRampToValueAtTime(target,now+time)}}},this.attr=function(userParams){for(var key in userParams)if(userParams.hasOwnProperty(key)&&__.isNotUndef(userParams[key])){var nativeNode=this.getNativeNode();if(__.isArr(nativeNode))flatten(nativeNode).forEach(function(_node){var mapping=userParams.mapping||getNodeWithUUID(_node.uuid).getParamMapping();applyParam(_node,key,userParams[key],mapping||{}),logToConsole(_node)});else{var mapping=userParams.mapping||getNodeWithUUID(nativeNode.uuid).getParamMapping();applyParam(nativeNode,key,userParams[key],mapping||{}),logToConsole(nativeNode)}}},this.search=function(str){var nodes=[];if(str)for(var prefix=this.getMacroNameSpace(),selector=prefix+str,nodeIds=getNodesWithSelector(selector),i=0;i<nodeIds.length;i++)getNodeWithUUID(nodeIds[i]).getMacroContainerUUID()===this.getUUID()&&nodes.push(nodeIds[i]);return nodes},this.getMacroNameSpace=function(){return macroNameSpace},this.setMacroNameSpace=function(name){name&&(macroNameSpace=name)},this.isMacro=function(){return __.isArr(nativeNode)},this.isMacroComponent=function(){return __.isNotUndef(macroContainerUUID)},this.setMacroContainerUUID=function(uuid){__.isStr(uuid)&&(macroContainerUUID=uuid)},this.getMacroContainerUUID=function(){return macroContainerUUID},this.getIsPlaying=function(){return isPlaying},this.setIsPlaying=function(bool){isPlaying=bool},this.getPrevNode=function(){return prevNode},this.setPrevNode=function(node){prevNode=node},this.pushNextNode=function(node){if(node){var nodes=getNodesToConnect(this,node),fromNode=getNodeWithUUID(nodes.from.uuid);fromNode.getUUID()!==this.getUUID()?fromNode.pushNextNode(node):nextNode.push(node)}},this.getUUID=function(){return uuid},this.getParams=function(){return parameters},this.getParamMapping=function(){return paramMapping},this.getType=function(){return nodeType},this.getID=function(){return parameters.settings.id||""},this.getClass=function(){return parameters.settings["class"]||""},this.areSiblings=function(node){var parentNodeID=__.isObj(node)?node.getMacroContainerUUID():__.isStr(node)?getNodeWithUUID(node).getMacroContainerUUID():"";return parentNodeID===this.getMacroContainerUUID()},this.isModulator=function(){return this.getMacroContainerUUID()&&getNodeWithUUID(this.getMacroContainerUUID()).getParams().settings.modulates?!0:!!this.getParams().settings.modulates},this.isModulatorType=function(){return this.isModulator()&&this.getMacroContainerUUID()&&getNodeWithUUID(this.getMacroContainerUUID()).getParams().settings.modulates?getNodeWithUUID(this.getMacroContainerUUID()).getParams().settings.modulates:this.isModulator()?this.getParams().settings.modulates:""},this.addNativeNode=function(nodeToAdd){nativeNode.push(nodeToAdd)},this.getNativeNode=function(){return nativeNode},this.resetNode=function(currNode){if(this.isMacro())getNodeWithUUID(currNode.uuid).resetNode(),updateNativeNode(getNodeWithUUID(currNode.uuid).getNativeNode(),currNode.uuid);else{var saved_buffer=nativeNode.buffer;nativeNode=audioNodeFactory(parameters),nativeNode.uuid=this.getUUID();for(var i=0;i<nextNode.length;i++)this.connect(nextNode[i]);this.connectPrevious(),this.setIsPlaying(!1),saved_buffer&&(nativeNode.buffer=saved_buffer)}},this.connect=function(nodeToConnect){if(nodeToConnect&&this.getUUID()!==nodeToConnect.getUUID()){var nodes=getNodesToConnect(this,nodeToConnect);nodes.from&&__.isFun(nodes.from.connect)&&nodes.to?nodes.from.connect(nodes.to):logToConsole("ERROR - connect did not happen")}},this.connectPrevious=function(){var pNode=this.getPrevNode();if(pNode&&this.getUUID()!==pNode.getUUID()){var nodes=getNodesToConnect(pNode,this);nodes.from&&__.isFun(nodes.from.connect)&&nodes.to?nodes.from.connect(nodes.to):logToConsole("ERROR - connect did not happen")}}}function toggleGrid(){_isLoopRunning&&(_ignoreGrid=!_ignoreGrid)}function startLoop(){_isLoopRunning||(_loopTimeToNextStep=_context.currentTime+_loopInterval/1e3,_loopID=setInterval(checkup,_loopInterval/1.75),_isLoopRunning=!0)}function stopLoop(){_isLoopRunning&&(clearInterval(_loopID),_isLoopRunning=!1,_loopTimeToNextStep=0)}function resetLoop(){_loopStepSize=16,_loopInterval=100,_ignoreGrid=!1,_loopID=0,_loopCB=function(){},_loopData=[],_loopListeners=[],_loopIndex=0,_isLoopRunning=!1,_loopTimeToNextStep=0}function configureLoop(opts,fn,data){opts&&(_loopStepSize=opts.steps||16,_loopInterval=opts.interval||100),__.isFun(fn)&&(_loopCB=fn),_loopData=__.isArr(data)&&data.length===_loopStepSize?data:[]}function checkup(){var now=_context.currentTime,timeAtPreviousStep=_loopTimeToNextStep-_loopInterval/1e3;_loopTimeToNextStep>now&&now>timeAtPreviousStep&&(loopStep(),_loopTimeToNextStep+=_loopInterval/1e3)}function loopStep(){_loopIndex=_loopStepSize-1>_loopIndex?_loopIndex+1:0,__.isFun(_loopCB)&&_loopCB(_loopIndex,cracked.ifUndef(_loopData[_loopIndex],null),_loopData);for(var i=0;i<_loopListeners.length;i++){var listener=_loopListeners[i],tmp=_selectedNodes;_selectedNodes=listener.selection,listener.callback(_loopIndex,cracked.ifUndef(listener.data[_loopIndex],null),listener.data),_selectedNodes=tmp}}function loadBuffer(userParams,node){userParams&&userParams.path&&node?loadBufferFromFile(userParams.path,node.getNativeNode()):userParams&&userParams.fn&&node&&loadBufferWithData(userParams.fn,node.getNativeNode())}function loadBufferWithData(dataFunction,buffersrc){dataFunction&&buffersrc&&(buffersrc.buffer=dataFunction(_context))}function loadBufferFromFile(path_to_soundfile,buffersrc){path_to_soundfile&&buffersrc&&fetchSoundFile(path_to_soundfile,function(sndArray){_context.decodeAudioData(sndArray,function(buf){buffersrc.buffer=buf,logToConsole("sound loaded")},function(){logToConsole("Couldn't load audio")})})}function fetchSoundFile(path,callback){if(path&&callback){var request=new XMLHttpRequest;request.open("GET",path,!0),request.responseType="arraybuffer",request.onload=function(){__.isFun(callback)&&callback(request.response)},request.send()}}function saveNode(node){updateMacro(node),setNode(node),setNodeLookup(node)}function setNode(node){_nodeStore[node.getUUID()]=node}function setNodeLookup(node){var params=node.getParams().settings,prefix=getCurrentMacroNamespace();if(__.isObj(params))for(var x in params)if("id"===x)setter(_nodeLookup,prefix+"#"+params[x],node.getUUID());else if("class"===x){var classArr=params[x].split(",");classArr.forEach(function(){setter(_nodeLookup,prefix+"."+params[x],node.getUUID())})}setter(_nodeLookup,"*",node.getUUID()),setter(_nodeLookup,prefix+node.getType(),node.getUUID())}function getNodeWithUUID(uuid){return uuid&&_nodeStore[uuid]?_nodeStore[uuid]:uuid&&__.isObj(uuid)&&"AudioNode"===uuid.constructor.name?uuid:__.isObj(uuid)&&__.isNotUndef(uuid.uuid)?getNodeWithUUID(uuid.uuid):null}function getNodesWithSelector(selector){var selector_array=selector.split(","),nodes=[];return selector_array.forEach(function(currSelector){if(currSelector&&_nodeLookup[currSelector]){var tmp=_nodeLookup[currSelector];tmp="id"===getSelectorType(currSelector)&&__.isArr(tmp)&&tmp.length>1?[tmp[0]]:tmp,nodes=arrayUnique(nodes.concat(tmp))}}),nodes}function getPreviousNode(){return _previousNode}function setPreviousNode(node){node&&(_previousNode=node)}function getSelectorType(str){return str.match(/^\./)?"class":str.match(/^\#/)?"id":"type"}function flatten(a,r){r=r||[];for(var i=0;i<a.length;i++)a[i].constructor===Array?flatten(a[i],r):r.push(a[i]);return r}function arrayUnique(array){for(var a=array.concat(),i=0;i<a.length;++i)for(var j=i+1;j<a.length;++j)a[i]===a[j]&&a.splice(j--,1);return a}function generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0,v="x"===c?r:3&r|8;return v.toString(16)})}function setter(map,key,value){map&&key&&(map[key]&&map[key].push?map[key].push(value):map[key]=[value])}function mergeObjects(source,target){source=source||{},target=target||{};for(var x in source)source.hasOwnProperty(x)&&(target[x]=source[x]);return target}function logNodes(node,arr){if(_currentSelector){var nodes=arr||[],selectedNodes=node||_selectedNodes;selectedNodes.forEach(function(nodeID,i,array){var tmp=getNodeWithUUID(nodeID).getNativeNode();__.isArr(tmp)&&logNodes(tmp,nodes),array===_selectedNodes&&nodes.push(tmp)})}}function logToConsole(msg){_debugEnabled&&console.log(msg)}function logConnections(nodeToConnect,node){var vals=[nodeToConnect.getType(),nodeToConnect.getID(),node.getType(),node.getID()];logToConsole("connected "+vals[0]+" - "+vals[1]+" to "+vals[2]+" - "+vals[3])}var _nodeStore={},_nodeLookup={},_previousNode=null,_selectedNodes=[],_currentSelector="",_currentMacro=[],_debugEnabled=!1,_context=window.AudioContext?new AudioContext:new webkitAudioContext,cracked=find;cracked.connect=function(){var tmp=getPreviousNode();return!tmp&&_selectedNodes.length&&(tmp=getNodeWithUUID(_selectedNodes[0])),find(arguments[0]),setPreviousNode(tmp),connectPreviousToSelected(),cracked},cracked.start=function(){if(!recordingMacro())for(var i=0;i<_selectedNodes.length;i++){var currNode=getNodeWithUUID(_selectedNodes[i]);currNode&&!currNode.getIsPlaying()&&currNode.start(0)}return cracked},cracked.stop=function(){for(var i=0;i<_selectedNodes.length;i++){var currNode=getNodeWithUUID(_selectedNodes[i]);currNode&&currNode.getIsPlaying()&&currNode.stop(0)}return cracked},cracked.ramp=function(value,endtime,paramToRamp,initial){for(var i=0;i<_selectedNodes.length;i++){var currNode=getNodeWithUUID(_selectedNodes[i]);currNode&&currNode.ramp(value,endtime,paramToRamp,null,initial)}return cracked},cracked.attr=function(userParams){for(var i=0;i<_selectedNodes.length;i++){var currNode=getNodeWithUUID(_selectedNodes[i]);currNode&&userParams&&currNode.attr(userParams)}return cracked},cracked.begin=function(name,userParams){return name&&_currentMacro.push(createMacro(name,userParams)),cracked},cracked.end=function(name){return recordingMacro()&&getCurrentMacro().getType()===name&&(getCurrentMacro().setMacroNameSpace(getCurrentMacroNamespace()),_currentMacro.pop()),cracked},cracked.exec=function(method,args,nodes){var save=_selectedNodes;return _selectedNodes=nodes,cracked[method].apply(cracked,args),_selectedNodes=save,cracked},cracked.filter=function(){var tmp=[];if(arguments&&arguments.length){var str=arguments[0],selectorType=getSelectorType(str),match=str.match(/^\.|\#/)?str.substring(1):str;_selectedNodes.forEach(function(nodeID){var node=getNodeWithUUID(nodeID);("type"===selectorType&&node.getType()===match||"class"===selectorType&&node.getClass()===match||"id"===selectorType&&node.getID()===match)&&tmp.push(nodeID)})}return tmp},cracked.each=function(fn){if(__.isFun(fn))for(var i=0;i<_selectedNodes.length;i++)fn(getNodeWithUUID(_selectedNodes[i]),i,_selectedNodes);return cracked};var _isLoopRunning=!1,_ignoreGrid=!1,_loopStepSize=16,_loopInterval=100,_loopID=0,_loopCB=function(){},_loopData=[],_loopIndex=0,_loopListeners=[],_loopTimeToNextStep=0;cracked.loop=function(){return arguments&&arguments.length&&("stop"===arguments[0]?stopLoop():"start"===arguments[0]?startLoop():"reset"===arguments[0]?resetLoop():"toggle_grid"===arguments[0]?toggleGrid():arguments[0]&&__.isObj(arguments[0])&&configureLoop(arguments[0],arguments[1],arguments[2])),cracked},cracked.bind=function(eventType,fn,data){return"step"===eventType&&__.isFun(fn)&&_loopListeners.push({eventType:eventType,callback:fn,data:data||[],selection:_selectedNodes.slice(0),selector:_currentSelector}),cracked},cracked.unbind=function(eventType){if("step"===eventType){var tmp=[];_loopListeners.forEach(function(el){_currentSelector!==el.selector&&tmp.push(el)}),_loopListeners=tmp}},cracked.script=function(userParams){function defaultFunction(e){for(var input=e.inputBuffer.getChannelData(0),output=e.outputBuffer.getChannelData(0),i=0;buffersize>i;i++)output[i]=input[i]}userParams=userParams||{};var buffersize=userParams.buffersize||4096,channels=userParams.channels||1,fn=userParams.fn||defaultFunction,creationParams={method:"createScriptProcessor",methodParams:[buffersize,channels,channels],settings:{onaudioprocess:fn}};return createNode("script",creationParams,userParams),cracked},cracked.waveshaper=function(userParams){function makeCurve(amount){for(var x,k=__.isNum(amount)?amount:50,n_samples=44100,curve=new Float32Array(n_samples),deg=Math.PI/180,i=0;n_samples>i;++i)x=2*i/n_samples-1,curve[i]=(3+k)*x*20*deg/(Math.PI+k*Math.abs(x));return curve}userParams=userParams||{};var drive=__.isObj(userParams)?cracked.ifUndef(userParams.drive,50):userParams,creationParams={method:"createWaveShaper",settings:{curve:userParams.curve||makeCurve(drive),mapping:{distortion:{path:"curve",fn:function(){return makeCurve}()}}}};return createNode("waveshaper",creationParams,userParams),cracked},cracked.compressor=function(userParams){var mapping={threshold:"threshold.value",knee:"knee.value",ratio:"ratio.value",attack:"attack.value",release:"release.value"},creationParams={method:"createDynamicsCompressor",settings:{},mapping:mapping};return createNode("compressor",creationParams,userParams),cracked},cracked.gain=function(userParams){var gain=__.isNum(userParams)?userParams:1,params=__.isObj(userParams)?userParams:{gain:gain},creationParams={method:"createGain",settings:{},mapping:{gain:"gain.value"}};return createNode("gain",creationParams,params),cracked},cracked.native_delay=function(userParams){var creationParams={method:"createDelay",methodParams:[179],settings:{},mapping:{delay:"delayTime.value"}};return createNode("delay",creationParams,userParams),cracked},cracked.osc=function(userParams){var creationParams={method:"createOscillator",settings:{},mapping:{frequency:"frequency.value",detune:"detune.value"}};return createNode("osc",creationParams,userParams),cracked},cracked.biquadFilter=function(userParams){var creationParams={method:"createBiquadFilter",settings:{},mapping:{q:"Q.value",frequency:"frequency.value",gain:"gain.value"}};return createNode("biquadFilter",creationParams,userParams),cracked},cracked.convolver=function(userParams){userParams=userParams||{};var creationParams={method:"createConvolver",settings:{}},node=createNode("convolver",creationParams,userParams);return loadBuffer(userParams,node),cracked},cracked.destination=function(userParams){return createNode("destination",{method:"createDestination",settings:{}},userParams),cracked},cracked.buffer=function(userParams){var creationParams={method:"createBufferSource",settings:{},mapping:{speed:"playbackRate.value",start:"loopStart",end:"loopEnd"}},buffersrc=createNode("buffer",creationParams,userParams);return loadBuffer(userParams,buffersrc),cracked},cracked.remove=function(){for(var arr=_currentSelector.split(","),i=0;i<arr.length;i++)if(_nodeLookup[arr[i]])for(var keyArr=Object.keys(_nodeLookup),j=0;j<keyArr.length;j++){var re=new RegExp(arr[i]+"\\s*");if(keyArr[j].match(re)){for(var tmp=_nodeLookup[keyArr[j]],k=0;k<tmp.length;k++){delete _nodeStore[[keyArr[j]][k]];var index=_nodeLookup["*"].indexOf(_nodeLookup[keyArr[j]][k]);index>-1&&_nodeLookup["*"].splice(index,1)}delete _nodeLookup[keyArr[j]]}}},cracked.log=function(){var arr=[];logNodes(null,arr),console.log(arr)},cracked.size=function(){return _selectedNodes.length?_selectedNodes.length:0},function(){-1!==window.location.href.indexOf("debug=true")&&(_debugEnabled=!0)}(),cracked._dumpState=function(){console.log(_nodeLookup)},cracked._getNode=function(uuid){return getNodeWithUUID(uuid)},cracked.version="0.1.0",window.cracked=cracked,window.__=window.__||cracked}(),cracked.ifUndef=function(test,def){return"undefined"==typeof test?def:test},cracked.isNotUndef=function(test){return"undefined"!=typeof test},cracked.isUndef=function(test){return"undefined"==typeof test},cracked.isObj=function(obj){return obj&&"object"==typeof obj},cracked.isNum=function(num){return null===num||""===num?!1:!isNaN(num)},cracked.isStr=function(str){return str&&"string"==typeof str},cracked.isArr=function(arr){return arr&&arr instanceof Array},cracked.isFun=function(fn){return fn&&fn instanceof Function},cracked.reverb=function(userParams){function buildImpulse(audioContext){var n,i,rate=audioContext.sampleRate,length=rate*_seconds,decay=_decay,impulse=audioContext.createBuffer(2,length,rate),impulseL=impulse.getChannelData(0),impulseR=impulse.getChannelData(1);for(i=0;length>i;i++)n=_reverse?length-i:i,impulseL[i]=(2*Math.random()-1)*Math.pow(1-n/length,decay),impulseR[i]=(2*Math.random()-1)*Math.pow(1-n/length,decay);return impulse}var params=__.ifUndef(userParams,{});params.path||(params.fn=params.fn||buildImpulse);var _seconds=__.ifUndef(params.seconds,3),_reverse=__.ifUndef(params.reverse,!1),_decay=__.ifUndef(params.decay,2);return __.begin("reverb",params).convolver(params).end("reverb"),cracked},cracked.delay=function(userParams){userParams=__.ifUndef(userParams,{});var time=__.isObj(userParams)?__.ifUndef(userParams.delay,1):userParams;return __.begin("delay",userParams),__.gain({id:"delay-input"}).native_delay({id:"native-delay",delay:time,mapping:{delay:"delayTime.value"}}).gain({id:"delay-damping",gain:__.ifUndef(userParams.damping,.84),mapping:{damping:"gain.value"}}).lowpass({id:"delay-cutoff",frequency:__.ifUndef(userParams.cutoff,1500),mapping:{cutoff:"frequency.value"}}).gain({id:"delay-feedback",gain:__.ifUndef(userParams.feedback,.5),mapping:{feedback:"gain.value"}}).gain({id:"delay-output"}),__("#delay-feedback").connect("#delay-input"),__("#native-delay").gain(.5).connect("#delay-output"),__.end("delay"),cracked},cracked.comb=function(params){var userParams=__.ifUndef(params,{});return __.begin("comb",userParams),__.gain({id:"comb-input"}).native_delay({id:"comb-delay",delay:__.ifUndef(userParams.delay,.027),mapping:{delay:"delayTime.value"}}).gain({id:"comb-damping",gain:__.ifUndef(userParams.damping,.84),mapping:{damping:"gain.value"}}).lowpass({id:"comb-cutoff",frequency:__.ifUndef(userParams.cutoff,3e3),mapping:{cutoff:"frequency.value"}}).gain({id:"comb-feedback",gain:__.ifUndef(userParams.feedback,.84),mapping:{feedback:"gain.value"}}).connect("#comb-input"),__("#comb-damping").gain({id:"output"}),__.end("comb"),cracked},cracked.bitcrusher=function(params){return params=params||{},__.begin("bitcrusher",params),__.script({fn:function(options){function crusher(e){for(var input=e.inputBuffer.getChannelData(0),output=e.outputBuffer.getChannelData(0),i=0;4096>i;i++)phaser+=normfreq,phaser>=1&&(phaser-=1,last=step*Math.floor(input[i]/step+.5)),output[i]=last}var bits=options.bits||6,normfreq=__.ifUndef(options.frequency,.1),step=Math.pow(.5,bits),phaser=0,last=0;return crusher}(params)}),__.end("bitcrusher"),cracked},cracked.ring=function(params){function setCurve(distortion){var i,samples,v,value,wsCurve,_i,_ref,vb,vl,h;for(vb=.2,vl=.4,h=__.ifUndef(distortion,1),samples=1024,wsCurve=new Float32Array(samples),i=_i=0,_ref=wsCurve.length;_ref>=0?_ref>_i:_i>_ref;i=_ref>=0?++_i:--_i)v=(i-samples/2)/(samples/2),v=Math.abs(v),value=vb>=v?0:v>vb&&vl>=v?h*(Math.pow(v-vb,2)/(2*vl-2*vb)):h*v-h*vl+h*(Math.pow(vl-vb,2)/(2*vl-2*vb)),wsCurve[i]=value;return wsCurve}var options=params||{},thisCurve=setCurve(__.ifUndef(options.distortion,1));return __.begin("ring",params),__.gain({id:"player"}).gain({id:"vcInverter1",gain:-1}).waveshaper({id:"vcDiode3",curve:thisCurve,mapping:{distortion:{path:"curve",fn:function(){return setCurve}()}}}).compressor({threshold:-12}),__("#player").waveshaper({id:"vInDiode4",curve:thisCurve,mapping:{distortion:{path:"curve",fn:function(){return setCurve}()}}}).connect("compressor"),__().sine({id:"vIn",frequency:options.frequency||30,mapping:{frequency:"frequency.value"}}).gain({id:"vInGain",gain:.5}).gain({id:"vInInverter1",gain:-1}).gain({id:"vInInverter2",gain:-1}).waveshaper({id:"vInDiode1",curve:thisCurve,mapping:{distortion:{path:"curve",fn:function(){return setCurve}()}}}).gain({id:"vInInverter3",gain:-1}).connect("compressor"),__("#vInGain").connect("#vInDiode4"),__("#vInGain").connect("#vcInverter1"),__("#vInInverter1").waveshaper({id:"vInDiode2",curve:thisCurve,mapping:{distortion:{path:"curve",fn:function(){return setCurve}()}}}).connect("#vInInverter3"),__("compressor").gain({id:"outGain",gain:4}),__.end("ring"),cracked},cracked.overdrive=function(userParams){function makeCurve(value){for(var k=100*value,n=22050,curve=new Float32Array(n),deg=Math.PI/180,i=0;n>i;i++){var x=2*i/n-1;curve[i]=(3+k)*x*20*deg/(Math.PI+k*Math.abs(x))}return curve}userParams=userParams||{};var drive=__.isObj(userParams)?__.ifUndef(userParams.drive,.5):userParams;return __.begin("overdrive",userParams),__.gain({id:"input"}).bandpass({frequency:__.ifUndef(userParams.color,800),mapping:{color:"frequency.value"}}).waveshaper({curve:makeCurve(drive),mapping:{drive:{path:"curve",fn:function(){return makeCurve}()}}}).lowpass({frequency:__.ifUndef(userParams.postCut,3e3),mapping:{postCut:"frequency.value"}}).gain({id:"output"}),__.end("overdrive"),cracked},cracked.adsr=function(userParams){function makeEnv(userParams,nodeParams){var segment,args=userParams||nodeParams,p=[0,0,0,0,0],options=args||.5;if(__.isArr(options)){if(5===options.length)p=options;else if(4===options.length){var sum=options[0]+options[1]+options[3];p=[options[0],options[1],options[2],sum/3,options[3]]}}else __.isNum(options)?(segment=options/4,p=[segment,segment,.5,segment,segment]):__.isStr(options)&&(options="slow"===options?1:"fast"===options?.25:.5,segment=options/4,p=[segment,segment,.5,segment,segment]);return p}var methods={init:function(options){options=options||{},options=__.isNum(options)||__.isArr(options)||__.isStr(options)?{envelope:options}:options,__.begin("adsr",options).gain({gain:0}).end("adsr")},trigger:function(params){cracked.each(function(el){if("adsr"===el.getType()){var p=makeEnv(params,el.getParams().settings.envelope);el.ramp([1,p[2],p[2],0],[p[0],p[1],p[3],p[4]],"gain",null,0)}})},release:function(){cracked.each(function(el){"adsr"===el.getType()&&el.ramp(0,.1,"gain")})}};return methods[userParams]?methods[userParams].apply(this,Array.prototype.slice.call(arguments,1)):methods.init(userParams),cracked},cracked.lowpass=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"lowpass",options.frequency=userParams.frequency||freq,options.q=__.ifUndef(userParams.q,0),options.mapping=userParams.mapping||{},__.begin("lowpass",userParams).biquadFilter(options).end("lowpass"),cracked},cracked.highpass=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"highpass",options.frequency=userParams.frequency||freq,options.q=__.ifUndef(userParams.q,0),options.mapping=userParams.mapping||{},__.begin("highpass",userParams).biquadFilter(options).end("highpass"),cracked},cracked.bandpass=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"bandpass",options.frequency=userParams.frequency||freq,options.q=__.ifUndef(userParams.q,0),options.mapping=userParams.mapping||{},__.begin("bandpass",userParams).biquadFilter(options).end("bandpass"),cracked},cracked.lowshelf=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"lowshelf",options.frequency=userParams.frequency||freq,options.q=__.ifUndef(userParams.q,0),options.gain=__.ifUndef(userParams.gain,0),options.mapping=userParams.mapping||{},__.begin("lowshelf",userParams).biquadFilter(options).end("lowshelf"),cracked},cracked.highshelf=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"highshelf",options.frequency=userParams.frequency||freq,options.gain=__.ifUndef(userParams.gain,0),options.q=__.ifUndef(userParams.q,0),options.mapping=userParams.mapping||{},__.begin("highshelf",userParams).biquadFilter(options).end("highshelf"),cracked},cracked.peaking=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"peaking",options.frequency=userParams.frequency||freq,options.q=__.ifUndef(userParams.q,0),options.gain=__.ifUndef(userParams.gain,0),options.mapping=userParams.mapping||{},__.begin("peaking",userParams).biquadFilter(options).end("peaking"),cracked},cracked.notch=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"notch",options.frequency=userParams.frequency||freq,options.q=__.ifUndef(userParams.q,10),options.mapping=userParams.mapping||{},__.begin("notch",userParams).biquadFilter(options).end("notch"),cracked},cracked.allpass=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"allpass",options.frequency=userParams.frequency||freq,options.q=__.ifUndef(userParams.q,10),options.mapping=userParams.mapping||{},__.begin("allpass",userParams).biquadFilter(options).end("allpass"),cracked
},cracked.dac=function(params){var gain=__.isNum(params)?params:1,userParams=__.isObj(params)?params:{},options={};return options.mapping=userParams.mapping||{},__.begin("dac",userParams).gain(gain).destination().end("dac"),cracked},cracked.sampler=function(params){return params&&params.path&&__.begin("sampler",params).buffer(params).end("sampler"),cracked},cracked.lfo=function(userParams){var params=userParams||{};return params.modulates=params.modulates||"frequency","white"===params.type||"pink"===params.type||"brown"===params.type?__().begin("lfo",params).noise({type:params.type||"white",channels:params.channels||1,length:params.length||1}).gain({gain:__.ifUndef(params.gain,1e3)}).end("lfo"):__().begin("lfo",params).osc({type:params.type||"sawtooth",frequency:params.frequency||6}).gain({gain:__.ifUndef(params.gain,1e3)}).end("lfo"),cracked},cracked.noise=function(params){var userParams=params||{};return"brown"===userParams.type?__.begin("noise",userParams).brown(userParams).end("noise"):"pink"===userParams.type?__.begin("noise",userParams).pink(userParams).end("noise"):__.begin("noise",userParams).white(userParams).end("noise"),cracked},cracked.pink=function(params){function buildBuffer(audioContext){function pinkify(buf,buffArr){var channelData,white,i,j,buffer=buf,b=[0,0,0,0,0,0,0],pink=[],bufNum=buffer.numberOfChannels,buflen=buffer.length;for(i=0;bufNum>i;i++){for(pink[i]=new Float32Array(buflen),channelData=buffArr[i],j=0;buflen>j;j++)white=channelData[j],b[0]=.99886*b[0]+.0555179*white,b[1]=.99332*b[1]+.0750759*white,b[2]=.969*b[2]+.153852*white,b[3]=.8665*b[3]+.3104856*white,b[4]=.55*b[4]+.5329522*white,b[5]=-.7616*b[5]-.016898*white,pink[i][j]=b[0]+b[1]+b[2]+b[3]+b[4]+b[5]+b[6]+.5362*white,pink[i][j]*=.11,b[6]=.115926*white;b=[0,0,0,0,0,0,0]}for(i=0;bufNum>i;i++)for(j=0;buflen>j;j++)buffArr[i][j]=pink[i][j]}for(var buf=audioContext.createBuffer(channels,length*audioContext.sampleRate,audioContext.sampleRate),buflen=buf.length,bufNum=buf.numberOfChannels,buffArr=[],k=0;bufNum>k;k++)buffArr.push(buf.getChannelData(k));for(var i=0;buflen>i;i++)for(var j=0;bufNum>j;j++)buffArr[j][i]=2*Math.random()-1;return pinkify(buf,buffArr),buf}var userParams=params||{},channels=userParams.channels||1,length=userParams.length||1;return __().begin("pink",userParams).buffer({fn:buildBuffer,loop:!0}).end("pink"),cracked},cracked.white=function(params){function buildBuffer(audioContext){for(var buffer=audioContext.createBuffer(channels,length*audioContext.sampleRate,audioContext.sampleRate),buflen=buffer.length,bufNum=buffer.numberOfChannels,buffArr=[],k=0;bufNum>k;k++)buffArr.push(buffer.getChannelData(k));for(var i=0;buflen>i;i++)for(var j=0;bufNum>j;j++)buffArr[j][i]=.44*(2*Math.random()-1);return buffer}var userParams=params||{},channels=userParams.channels||1,length=userParams.length||1;return __().begin("white",userParams).buffer({fn:buildBuffer,loop:!0}).end("white"),cracked},cracked.brown=function(params){function buildBuffer(audioContext){for(var buffer=audioContext.createBuffer(channels,length*audioContext.sampleRate,audioContext.sampleRate),lastOut=0,bufLen=buffer.length,bufNum=buffer.numberOfChannels,buffArr=[],k=0;bufNum>k;k++)buffArr.push(buffer.getChannelData(k));for(var i=0;bufLen>i;i++)for(var j=0;bufNum>j;j++){var white=2*Math.random()-1;buffArr[j][i]=(lastOut+.02*white)/1.02,lastOut=buffArr[j][i],buffArr[j][i]*=3.5}return buffer}var userParams=params||{},channels=userParams.channels||1,length=userParams.length||1;return __().begin("brown",userParams).buffer({fn:buildBuffer,loop:!0}).end("brown"),cracked},cracked.sine=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"sine",options.frequency=userParams.frequency||freq,options.detune=userParams.detune||0,options.mapping=userParams.mapping||{},__.begin("sine",userParams).osc(options).end("sine"),cracked},cracked.square=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"square",options.frequency=userParams.frequency||freq,options.detune=userParams.detune||0,options.mapping=userParams.mapping||{},__.begin("square",userParams).osc(options).end("square"),cracked},cracked.saw=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"sawtooth",options.frequency=userParams.frequency||freq,options.detune=userParams.detune||0,options.mapping=userParams.mapping||{},__.begin("saw",userParams).osc(options).end("saw"),cracked},cracked.triangle=function(params){var freq=__.isNum(params)?params:440,userParams=__.isObj(params)?params:{},options={};return options.type=userParams.type||"triangle",options.frequency=userParams.frequency||freq,options.detune=userParams.detune||0,options.mapping=userParams.mapping||{},__.begin("triangle",userParams).osc(options).end("triangle"),cracked},cracked.monosynth=function(params){var methods={init:function(){__().begin("monosynth",params).lfo({gain:0}).sine().lowpass({q:0}).adsr().gain().end("monosynth")},noteOn:function(params){var args=params||{},freq=__.pitch2freq(__.isNum(params)?params:args.pitch),env=args.envelope||1;cracked.each(function(el){"monosynth"===el.getType()&&(cracked.exec("frequency",[freq],el.search("sine")),cracked.exec("adsr",["trigger",env],el.search("adsr")))})},noteOff:function(){cracked.each(function(el){"monosynth"===el.getType()&&cracked.exec("adsr",["release",[]],el.search("adsr"))})}};return methods[params]?methods[params].apply(this,Array.prototype.slice.call(arguments,1)):methods.init(params),cracked},cracked.cracksynth=function(params){var methods={init:function(){__().begin("cracksynth",params).lfo({gain:100}).sine().lowpass({q:20}).adsr().gain().end("cracksynth")},noteOn:function(params){var args=params||{},freq=__.pitch2freq(__.isNum(params)?params:args.pitch),env=args.envelope||1;cracked.each(function(el){"cracksynth"===el.getType()&&(cracked.exec("frequency",[freq],el.search("sine")),cracked.exec("adsr",["trigger",env],el.search("adsr")),cracked.exec("ramp",[[100,10],[.5*env,.5*env],"frequency",10],el.search("lfo")),cracked.exec("ramp",[[freq/2,3*freq],[.1*env,.9*env],"frequency",3*freq],el.search("lowpass")))})},noteOff:function(){cracked.each(function(el){"cracksynth"===el.getType()&&cracked.exec("adsr",["release",[]],el.search("adsr"))})}};return methods[params]?methods[params].apply(this,Array.prototype.slice.call(arguments,1)):methods.init(params),cracked},cracked.frequency=function(userParam){return __.isNum(userParam)&&cracked.attr({frequency:userParam}),cracked},cracked.detune=function(userParam){return __.isNum(userParam)&&cracked.attr({detune:userParam}),cracked},cracked.volume=function(userParam){return __.isNum(userParam)&&cracked.attr({gain:userParam}),cracked},cracked.time=function(userParam){return __.isNum(userParam)&&cracked.attr({delay:userParam}),cracked},cracked.feedback=function(userParam){return __.isNum(userParam)&&cracked.attr({feedback:userParam}),cracked},cracked.speed=function(userParam){return __.isNum(userParam)&&cracked.attr({speed:userParam}),cracked},cracked.drive=function(userParam){return __.isNum(userParam)&&cracked.attr({drive:userParam}),cracked},cracked.distortion=function(userParam){return __.isNum(userParam)&&cracked.attr({distortion:userParam}),cracked},cracked.play=function(){return cracked("*").start(),cracked},cracked.scale=function(type){return{major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10]}[type]},cracked.pitch2freq=function(pitch){return 440*Math.pow(2,(Math.floor(pitch)-69)/12)},cracked.shuffle=function(arr){for(var temp,index,counter=arr.length;counter>0;)index=Math.floor(Math.random()*counter),counter--,temp=arr[counter],arr[counter]=arr[index],arr[index]=temp;return arr},cracked.random=function(min,max){return Math.round(min+Math.random()*(max-min))},cracked.isSupported=function(){return"AudioContext"in window||"webkitAudioContext"in window};