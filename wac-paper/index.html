<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Adventures in scheduling, buffers and parameters</title>

		<meta name="description" content="Adventures in scheduling, buffers and parameters : Porting a dynamic audio engine to Web Audio">
		<meta name="author" content="Chinmay Pendharkar">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.min.css">
		<link rel="stylesheet" href="css/theme/beige-sparse.css" id="theme">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- If the query includes 'print-pdf', include the PDF print sheet -->
		<script>
			if( window.location.search.match( /print-pdf/gi ) ) {
				var link = document.createElement( 'link' );
				link.rel = 'stylesheet';
				link.type = 'text/css';
				link.href = 'css/print/pdf.css';
				document.getElementsByTagName( 'head' )[0].appendChild( link );
			}
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<!-- Title Slide -->
				<section>
					<h2>Adventures in scheduling, buffers and parameters</h2>
					<br>
					<h3>Porting a dynamic audio engine to Web Audio</h3>
					<p>
						<br>
						<br>
						<small><a href="http://chinpen.net">Chinmay Pendharkar, Peter BÃ¤ck and Lonce Wyse</a> / <a href="http://sonoport.com">Sonoport</a></small>
					</p>
				</section>

				<!-- Sonoport Intro -->

				<section>
					<img class="spare-image-no-border" src="img/sonoport.png">
					<p>
						<em class="spare-subtitle" >If visuals can be interactive, why can't audio?</em>
					</p>
					<br>
					<br>
					<br>
					<br>
					</style>
					<div class="spare-twocolumn-wrap">
					    <div class="spare-twocolumn-left_col">
					        <img class="spare-image-no-border" style="margin:0px 30px" src="img/about-sg.png">
					        <img class="spare-image-no-border" style="margin:0px" src="img/about-uk.png">
					        <p>Singapore/London</p>
					    </div>
					    <div class="spare-twocolumn-right_col">
					        <p>Interactive Dynamic Audio for Multimedia</p>
					        <p class="spare-subtitle">(Ads, Games, Etc)</p>
					    </div>
					</div>

				</section>

				<section>
					<h2>Sonoport Studio</h2>
					<ul>
						<li>Interactive audio authoring platform</li>
						<li>Web Based</li>
						<!-- Screen Shot of Sonoport Studio -->
						<li>Core : Dynamic Sound Engine
						<ul style="margin-top:10px">
								<li>
									Collection of Sonoport Dynamic Sound Models
								</li>
								<li>
									Runtime + Utilities
								</li>
						</ul>
						</li>
					</ul>
				</section>

				<section>
					<h2>Sonoport Dynamic Sound Models</h2>
					<ul>
						<li> Algorithms that make sound</li>
						<li> Parameters to change the sounds in real-time</li>
						<li> Texture based or purely Synthesized </li>
					</ul>
				</section>



				<section>
					<h2>History</h2>
					<ul>
						<li> Based on Lonce's work in Java/Flex </li>
						<li> Moved to Flash (starting with Flash 10)</li>
						<li> January 2014 - Starting migration to WebAudio</li>
					</ul>
				</section>

				<!-- Porting Problem -->

				<section>
					<h2>Architecture</h2>
					<ul>
						<li> Keep API Consistency with Flash version </li>
						<li> Leverage on Web Audio for 'plumbing' </li>
						<li> Leverage the composibilty of Web Audio </li>
						<li> Use existing frameworks? - <em>Not invented here!</em></li>
					</ul>
				</section>

				<section>
					<h2>Architecture - Threading</h2>
					<ul>
						<li> Avoid <strong>ScriptProcessorNode</strong> </li>
						<li> Sound Models are usually embedded in other websites </li>
						<li> No gurantee that nothing else will hog the event loop </li>
						<li> Risk of missing <strong>ScriptProcessorNode</strong> callbacks</li>
					</ul>
				</section>

				<section>
					<h2>Architecture - Trade-offs</h2>
					<ul>
						<li> Change API for Parameters </li>
						<li> .. for Automation method support </li>
						<pre> <code data-trim>
/* Flash */
loop.speed = 0.4;
/* Web Audio */
loop.speed.value = 0.4;
/* Automation FTW */
loop.speed.exponentialRampToValueAtTime(0.4, 5);
						</code> </pre>
					</ul>
				</section>

				<section>
					<h2>Architecture - Higher Level Nodes</h2>
					<ul>
						<li> Wanted to create <strong>AudioNode</strong>-like JS Objects </li>
						<li> <strong>SPAudioNode</strong> - Similar interface to AudioNode </li>
						<li> All Sound Models are <strong>SPAudioNode</strong>s </li>
						<li> <strong>SPAudioNode</strong> internally composes multiple <strong>AudioNodes</strong> </li>
						<li> OpenMusic (Sole's) approach might be more elegant </li>
					</ul>
				</section>

				<!-- Diagram of SPAudioNodes-->

				<section>
					<h2 class="spare-nonuppercase">SPAudioNode</h2>
						<pre> <code data-trim>
/* Construct */
var node = new SPAudioNode(context);

/* Manipulate */
node.fooparam.value = 42;
node.barparam.setTargetAtTime(12,2);

/* Connect with other AudioNodes */
var filter = new context.createBiquadFilter();
node.connect(filter);
filter.connect(context.destination);
						</code> </pre>
				</section>

				<!-- Parameters -->
				<section>
					<h2> 3 Problems : 3 Hacks! </h2>
				</section>

				<section>
					<p class="spare-problem">Problem #1 : Can't create custom Parameters in Web Audio</p>
				</section>

				<section>
					<h2>Problem #1</h2>
					<ul>
						<li> Higher Level Nodes need Parameters </li>
						<li> Parameters should have similar interface as AudioParam</li>
						<li> Parameters may need to be mapped to internal AudioNodes</li>
						<li> Bonus : Parameters support Automation</li>
					</ul>
				</section>

				<section>
					<p class="spare-problem">Solution #1: SPAudioParam </p>
					<p class="spare-subtitle"> Wrap Around <em>AudioParams</em>, expose similar interface to AudioParams</p>
				</section>

				<section>
					<h2 class="spare-nonuppercase">SPAudioParam - Two Approaches</h2>
					<div class="spare-twocolumn-wrap">
					    <div class="spare-twocolumn-left_col">
							<p class="spare-column-header"> <strong> Wrapped SPAudioParam </strong> </p>
							<ul>
								<li> Map SPAudioParam to underlying AudioParam </li>
								<li> Use getters/setters to pass along values </li>
								<li> Mapping/normalization on the fly</li>
								<li> Pass along Automation method calls </li>
							</ul>
					    </div>
					    <div class="spare-twocolumn-right_col">
					    <p class="spare-column-header"> <strong style=""> Mocked SPAudioParam </strong> </p>
					    <ul>
								<li> Plain old JS Object </li>
								<li> Fakes Automation using setInterval (URGH!)</li>
								<li> For edge case without underlying AudioParam</li>
							</ul>
					    </div>
					</div>
				</section>

				<section>
					<h2>Solution #1: SPAudioParam </h2>
					<ul>
						<li> Mostly used Wrapped SPAudioParam approach </li>
						<li> Slight change in API for Parameters but free automation!!</li>
						<li> Mocked Param approach handy in edge case scenarios </li>
					</ul>
				</section>

				<!-- Queue -->

				<section>
					<p class="spare-problem">Problem #2 : Can't schedule some operations in Web Audio</p>
				</section>

				<section>
					<h2>Problem #2 - Queues</h2>
					<ul>
						<li> Scheduling is key, but can't un-schedule in WebAudio.</li>
						<li> Keep a Queue, schedule/unschedule on the Queue. </li>
						<li> Queue executes 'Events' as close (without overshooting) to the scheduled time.</li>
						<li> Common Queue Events : Start, Stop, Change Param</li>
					</ul>
				</section>

				<section>
					<h2>Problem #2 - Polyphony</h2>
					<ul>
						<li> Polyphonic Models with multiple voices </li>
						<li> Typical archtecture, fixed number of BufferNodes </li>
						<li> Queue assignes various buffers to those BufferNodes at the scheduled time</li>
					</ul>
				</section>

				<section>
					<!-- Queuing diagram -->
				</section>

				<section>
					<li> New Queue Event : SetSource &lt;- not schedulable!</li>
					<li> SetInterval for timing may cause SetSource to be executed AFTER Start </li>
					<li> Executing SetSource at queueing time could override another voice.</li>
				</section>

				<section>
					<p class="spare-problem">Solution #2: Fire and Forget Voices </p>
					<p class="spare-subtitle"> Create new voices as and when needed; ensure GC when discarding used voices.</p>
				</section>

				<section>
					<ul>
						<li> Change Architecture : new BufferNode everytime a voice is needed </li>
						<li> Ensure GC does capture all the BufferNodes </li>
						<li> Test no leaks using memory profiling and heap dumps</li>
						<li> Tested to upto ~60x3 Nodes created per second (no audible glitching)</li>
					</ul>
				</section>>

				<section>
					<!-- Demo Multitrigger -->
				</section>

				<!-- Buffers -->

				<section>
					<p class="spare-problem">Problem #3 : Can't pause then play an AudioSourceBufferNode</p>
				</section>

				<section>
					<p class="spare-problem">Solution #3: SPAudioSourceBufferNode </p>
					<p class="spare-subtitle"> Wrap Around <em>AudioSourceBufferNode</em>, and track it's playback using a 'Scope'.</p>
				</section>


				<section>
					<h2>Summary</h2>
					<ul>
						<li> Overcame most issues using current implementation of Web Audio </li>
						<li> Most solutions were Hacks </li>
						<li> Most solutions worked for our specific usecase </li>
						<li> Youy millage may vary based on what you're doing </li>
					</ul>
				</section>

					<!-- Audio Worker and the Future -->

				<section>
					<h2>Enter the Audio Worker!</h2>
				</section>

				<section>
					<img src="img/icanhaz.jpg">
				</section>

				<section>
					<h2>Parameters</h2>
					<ul>
						<li> AudioWorkers have <strong>addParameter</strong> method! </li>
						<li> Create a-rate parameter values accessible inside AudioWorkers! </li>
						<li> Should solve all issues with creating custom Parameters</li>
					</ul>
				</section>

				<section>
					<h2>Scheduling</h2>
					<ul>
						<li> AudioWorkers enables glitch free sample accurate scheduling </li>
						<li> Queue runs inside an AudioWorker </li>
						<li> Load operations can be scheduled accurately </li>
					</ul>
				</section>

				<section>
					<h2>Buffers</h2>
					<ul>
						<li> Still no <strong>playbackPosition</strong> property on AudioSourceBufferNode </li>
						<li> :( </li>
						<li> .. but I an reimplement AudioSourceBufferNode inside AudioWorker!</li>
						<li> No idea of performance till I have access to AudioWorker</li>
					</ul>
				</section>

				<!-- Last Slide -->
				<section>
					<h2>Questions?</h2>
					<p style="margin-top : 200px">Slides, Papers, Links at <a href="http://wac.sonoport.com">http://wac.sonoport.com</a><p>
				</section>

			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.min.js"></script>

		<script>

			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,
				slideNumber: true,
				theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'fade', // default/cube/page/concave/zoom/linear/fade/none

				// Parallax scrolling
				//parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
				// parallaxBackgroundSize: '2100px 900px',

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});

		</script>



	</body>
</html>
